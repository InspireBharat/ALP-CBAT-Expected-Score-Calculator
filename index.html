<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RRB ALP 2024 CBAT – T‑Score & Report</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root {
    --bg: #0a0f1f;
    --card: #121834;
    --accent: #4f8cff;
    --accent2: #00d4a6;
    --text: #e8ecff;
    --muted: #a9b3d6;
    --warn: #ffb020;
    --danger: #ff5565;
    --card-gradient: linear-gradient(145deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
    --input-bg: rgba(13, 19, 42, 0.7);
    --success: #00c781;
  }
  
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  
  body {
    font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
    color: var(--text);
    background: radial-gradient(1200px 600px at 10% -10%, #1b2658 0, #0a0f1f 60%);
    min-height: 100vh;
    line-height: 1.6;
  }
  
  /* NAV */
  nav {
    position: sticky;
    top: 0;
    z-index: 10;
    background: rgba(10, 15, 31, 0.85);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }
  
  .nav-inner {
    max-width: 1100px;
    margin: 0 auto;
    padding: 12px 16px;
    display: flex;
    align-items: center;
    gap: 16px;
  }
  
  .brand {
    display: flex;
    align-items: center;
    gap: 10px;
    text-decoration: none;
    color: var(--text);
    font-weight: 700;
    font-size: 1.1rem;
  }
  
  .spacer {
    flex: 1;
  }
  
  .nav-link {
    color: var(--muted);
    text-decoration: none;
    margin-left: 14px;
    transition: color 0.2s ease;
  }
  
  .nav-link:hover {
    color: var(--text);
  }
  
  .home-btn {
    color: var(--text);
    text-decoration: none;
    font-weight: 600;
  }
  
  .btn-telegram {
    background: linear-gradient(90deg, #0088cc, #2AABEE);
    color: white !important;
    border: none;
    padding: 10px 16px;
    border-radius: 10px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
    text-decoration: none;
    transition: all 0.2s ease;
    box-shadow: 0 4px 12px rgba(42, 171, 238, 0.3);
  }
  
  .btn-telegram:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(42, 171, 238, 0.4);
  }

  /* Style for date input with glowing white calendar icon */
input[type="date"] {
  position: relative;
  padding-right: 40px; /* space for the icon */
  background: #222;
  color: #fff;
  border: 1px solid #555;
  border-radius: 5px;
  font-size: 16px;
  height: 40px;
  box-shadow: inset 0 0 5px rgba(255,255,255,0.2);
}

/* Remove default browser calendar icon */
input[type="date"]::-webkit-calendar-picker-indicator {
  opacity: 0;
  cursor: pointer;
  position: absolute;
  right: 10px;
  height: 100%;
  width: 30px;
}

/* Add custom white glowing calendar icon */
input[type="date"]::after {
  content: "📅";
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  color: white;
  font-size: 18px;
  pointer-events: none;
  text-shadow: 0 0 8px rgba(255,255,255,0.8);
}

  /* Layout */
  .container {
    max-width: 1100px;
    margin: 32px auto;
    padding: 0 16px;
  }
  
  .card {
    background: var(--card-gradient);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 18px;
    padding: 28px;
    box-shadow: 0 12px 30px rgba(0, 0, 0, 0.3);
    margin-bottom: 24px;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  
  .card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
  }
  
  h1 {
    font-size: 32px;
    margin: 0 0 12px;
    background: linear-gradient(90deg, var(--text), var(--accent));
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    font-weight: 800;
  }
  
  h2 {
    font-size: 24px;
    margin: 0 0 12px;
    color: #dfe6ff;
    font-weight: 700;
    padding-bottom: 8px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }
  
  h3 {
    font-size: 20px;
    margin: 0 0 8px;
    color: #dfe6ff;
    font-weight: 600;
  }
  
  p {
    color: var(--muted);
    margin-bottom: 16px;
  }

  /* Popup */
  .popup {
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(5px);
    z-index: 999;
    animation: fadeIn 0.3s ease;
  }
  
  .popup .panel {
    width: min(700px, 92%);
    background: var(--card);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 18px;
    padding: 28px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
    animation: slideUp 0.4s ease;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  @keyframes slideUp {
    from { 
      opacity: 0;
      transform: translateY(20px);
    }
    to { 
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Form styling */
  .grid {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    gap: 16px;
    margin-top: 20px;
  }
  
  .col-12 {
    grid-column: span 12;
  }
  
  .col-6 {
    grid-column: span 6;
  }
  
  .col-4 {
    grid-column: span 4;
  }
  
  .field {
    display: flex;
    flex-direction: column;
    gap: 8px;
    position: relative;
  }
  
  label {
    font-size: 14px;
    color: #cbd5ff;
    font-weight: 500;
  }
  
  input, select {
    background: var(--input-bg);
    color: var(--text);
    border: 1px solid rgba(255, 255, 255, 0.12);
    padding: 14px 16px;
    border-radius: 12px;
    outline: none;
    font-size: 15px;
    transition: all 0.3s ease;
  }
  
  input:hover, select:hover {
    border-color: rgba(255, 255, 255, 0.2);
  }
  
  input:focus, select:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(79, 140, 255, 0.25);
    transform: translateY(-2px);
  }
  
  .row {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
    margin-top: 20px;
  }
  
  .btn {
    appearance: none;
    border: none;
    cursor: pointer;
    padding: 14px 20px;
    border-radius: 12px;
    font-weight: 600;
    font-size: 15px;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }
  
  .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(79, 140, 255, 0.4);
  }
  
  .btn:active {
    transform: translateY(0);
  }
  
  .btn {
    background: linear-gradient(90deg, var(--accent), #7aa5ff);
    color: #071028;
    box-shadow: 0 8px 20px rgba(79, 140, 255, 0.35);
  }
  
  .btn.secondary {
    background: rgba(13, 19, 42, 0.7);
    color: var(--text);
    border: 1px solid rgba(255, 255, 255, 0.16);
    box-shadow: none;
  }
  
  .btn.secondary:hover {
    background: rgba(20, 28, 58, 0.8);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
  }
  
  .btn.warn {
    background: linear-gradient(90deg, var(--warn), #ffd28a);
    color: #2a1700;
    box-shadow: 0 8px 20px rgba(255, 176, 32, 0.35);
  }
  
  .btn.danger {
    background: linear-gradient(90deg, var(--danger), #ff98a4);
    color: #2a0005;
    box-shadow: 0 8px 20px rgba(255, 85, 101, 0.35);
  }

  /* Tables */
  table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    margin-top: 20px;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
  }
  
  thead {
    background: linear-gradient(90deg, var(--accent), #6b9dff);
  }
  
  th, td {
    padding: 16px 20px;
    text-align: left;
  }
  
  th {
    color: #071028;
    font-weight: 700;
    font-size: 15px;
  }
  
  tbody tr {
    background: rgba(255, 255, 255, 0.05);
    transition: background 0.2s ease;
  }
  
  tbody tr:nth-child(even) {
    background: rgba(255, 255, 255, 0.03);
  }
  
  tbody tr:hover {
    background: rgba(79, 140, 255, 0.15);
  }
  
  td {
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
  }
  
  tr:last-child td {
    border-bottom: none;
  }
  
  td small {
    color: var(--muted);
    font-size: 13px;
  }
  
  .pill {
    display: inline-flex;
    gap: 6px;
    align-items: center;
    padding: 6px 12px;
    border-radius: 999px;
    border: 1px solid rgba(255, 255, 255, 0.12);
    background: rgba(255, 255, 255, 0.08);
    color: #e7eeff;
    font-size: 13px;
    font-weight: 500;
  }

  /* Sections */
  #formWrap, #reportWrap, #adminWrap {
    display: none;
  }
  
  #reportMeta {
    background: rgba(255, 255, 255, 0.05);
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 20px;
    border-left: 4px solid var(--accent);
  }
  
  .score-highlight {
    font-size: 24px;
    font-weight: 700;
    color: var(--accent2);
    margin: 10px 0;
  }

  /* Footer */
  footer {
    text-align: center;
    color: var(--muted);
    margin: 40px 0;
    font-size: 14px;
    padding: 20px;
    border-top: 1px solid rgba(255, 255, 255, 0.08);
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .grid {
      grid-template-columns: 1fr;
      gap: 12px;
    }
    
    .col-6, .col-4 {
      grid-column: span 1;
    }
    
    .row {
      flex-direction: column;
      gap: 12px;
    }
    
    .nav-inner {
      flex-wrap: wrap;
    }
    
    h1 {
      font-size: 26px;
    }
    
    h2 {
      font-size: 22px;
    }
    
    .card {
      padding: 20px;
    }
    .field.col-6 { 
        width: 48%; 
        display:inline-block; 
        margin-right:2%; 
    }
    .field.col-12 { 
        width: 100%; 
        display:block; 
    }
  }

  .note-box {
    border: 2px solid #ddd;
    border-radius: 8px;
    padding: 16px 20px;
    margin: 20px 0;
    font-size: 15px;
    line-height: 1.6;
  }
  .note-box h2 {
    margin-top: 0;
    color: #ffffff;
    text-align: center;
    font-size: 18px;
  }
  .note-box ul {
    padding-left: 20px;
  }
  .note-box li {
    margin-bottom: 12px;
  }
  .note-box strong {
    color: #000;
  }
  .yes {
    color: green;
    font-weight: bold;
  }
  .no {
    color: red;
    font-weight: bold;
  }
  .info-box {
    border: 2px solid #ddd;
    border-radius: 8px;
    padding: 15px 20px;
    margin: 15px 0;
    font-size: 14px;
    line-height: 1.6;
  }
  .info-box h3 {
    margin-top: 0;
    font-size: 16px;
    color: #ffffff;
  }
  .info-box ul {
    padding-left: 18px;
    margin: 10px 0;
  }
  .info-box li {
    margin-bottom: 10px;
  }
  .good {
    color: green;
    font-weight: bold;
  }
  .bad {
    color: red;
    font-weight: bold;
  }
  .note-box {
    border: 2px solid #fbc02d;
    border-radius: 6px;
    padding: 12px 15px;
    margin: 15px 0;
    font-size: 14px;
    line-height: 1.6;
  }
  .note-box p {
    margin: 8px 0;
  }
  .note-box strong {
    color: #d32f2f;
  }
  .channel-buttons {
    margin: 20px 0;
    display: flex;
    justify-content: center;
    gap: 12px;
    flex-wrap: wrap; /* allows wrapping */
  }

  .channel-buttons .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    width: 200px; /* same width */
    padding: 12px;
    font-size: 15px;
    font-weight: 600;
    border-radius: 6px;
    text-decoration: none;
    transition: 0.2s ease-in-out;
    text-align: center;
  }

  .btn-youtube {
    background: #ff0000;
    color: #fff;
  }
  .btn-youtube:hover {
    background: #cc0000;
  }

  .btn-telegram {
    background: #0088cc;
    color: #fff;
  }
  .btn-telegram:hover {
    background: #006f9e;
  }

  .btn svg {
    vertical-align: middle;
  }

  /* ✅ Responsive: Stack vertically on small screens */
  @media (max-width: 500px) {
    .channel-buttons {
      flex-direction: column;
      align-items: center;
    }
    .channel-buttons .btn {
      width: 90%; /* full width but with margin */
      max-width: 300px;
    }
  }
</style>
</head>
<body>

<nav>
  <div class="nav-inner">
    <a class="brand home-btn" href="./">
        <span class="glow-text">RRB ALP 2024 CBAT Expected Score Calculator</span>
    </a>
    <a class="btn btn-outline-light btn-glow" href="./"> 
        <i class="fas fa-home"></i> Home
    </a>

    <div class="spacer"></div>
    <div class="channel-buttons">
      <!-- YouTube Channel Button -->
      <a href="https://www.youtube.com/channel/UCHS293AMtVG3HINTF5L-V3Q" target="_blank" class="btn btn-youtube">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 576 512">
          <path d="M549.7 124.1c-6.3-23.7-24.9-42.3-48.6-48.6C465.3 64 288 64 288 64S110.7 64 
                  74.9 75.5c-23.7 6.3-42.3 24.9-48.6 48.6C16 160 16 256 16 
                  256s0 96 10.3 131.9c6.3 23.7 24.9 42.3 48.6 48.6C110.7 
                  448 288 448 288 448s177.3 0 213.1-11.5c23.7-6.3 
                  42.3-24.9 48.6-48.6C560 352 560 256 560 
                  256s0-96-10.3-131.9zM232 336V176l142 
                  80-142 80z"/>
        </svg>
        <span>YouTube Channel</span>
      </a>

      <!-- Telegram Channel Button -->
      <a href="https://t.me/Akki_Inspire" target="_blank" class="btn btn-telegram">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 496 512">
          <path d="M248 8C111 8 0 119 0 256s111 248 248 
                  248 248-111 248-248S385 8 248 8zm116.4 
                  169.9l-38.4 181.2c-2.9 13.2-10.7 16.5-21.6 
                  10.3l-60-44.3-28.9 27.8c-3.2 3.2-5.9 5.9-12.1 
                  5.9l4.3-61.2 111.3-100.5c4.8-4.3-1-6.7-7.4-2.4L153.9 
                  279.5l-59-18.4c-12.8-4-13.1-12.8 2.7-19.1l230.6-89.1c10.7-3.9 
                  20.1 2.6 16.2 19.1z"/>
        </svg>
        <span>Telegram Channel</span>
      </a>
    </div>
  </div>
</nav>

<div class="container">
  <div class="card" id="hero">
    <h1>CBAT T‑Score & Overall Score (out of 30)</h1>
    <h1>सीबीएटी टी-स्कोर और कुल स्कोर (30 में से)</h1>
    <p>Auto-calculated from your Battery raw scores within <strong>Same (Zone + Exam Date + Shift)</strong> and grouped by <strong>Re‑Exam</strong> status.</p>
    <p><strong>समान (जोन + परीक्षा तिथि + शिफ्ट)</strong> और <strong>पुनः परीक्षा</strong> स्थिति के अनुसार समूहीकृत की जाती है।, में आपके बैटरी रॉ स्कोर से स्वचालित रूप से गणना की जाती है</p>
  </div>

  <!-- POPUP -->
  <div class="popup" id="firstPopup">
    <div class="panel">
      <h1>
        Have you filled the form earlier?
        <br>
        क्या आपने पहले फॉर्म भरा है?        
      </h1>
      <div class="note-box">
        <h2>⚠️ महत्वपूर्ण नोट (Hindi)</h2>
        <ul>
          <li>
            <span class="yes">✔️ Yes</span> पर क्लिक करें और पहले से भरे गए <u>Unique CBAT Roll No</u> से 
            अपडेटेड औसत और T-Score देखें।  
            <br><em>👉 केवल स्कोर देखने के लिए दोबारा फॉर्म न भरें।</em>
          </li>
          <li>
            <span class="no">❌ No</span> पर क्लिक करें यदि आप <u>जानकारी अपडेट</u> करना चाहते हैं।  
            <br>कृपया उसी <u>Unique Roll No</u> और सही जानकारी (Date, Part A Marks, Correct Attempts Battery Wise, Zone, Category, Re-Exam, Shift) के साथ दोबारा फॉर्म भरें।
          </li>
          <li>
            पहली बार फॉर्म भरते समय भी <span class="no">❌ No</span> चुनें और सभी जानकारी सही भरें।
          </li>
        </ul>

        <h2>⚠️ Important Note (English)</h2>
        <ul>
          <li>
            Click <span class="yes">✔️ Yes</span> to see Updated Average & T-Score using your 
            <u>Unique CBAT Roll No</u> (already submitted).  
            <br><em>👉 Do not refill the form only for checking scores.</em>
          </li>
          <li>
            Click <span class="no">❌ No</span> to <u>Update details</u> with the same Unique RollNo 
            (Date, Part A Marks, Correct Attempts Battery Wise, Zone, Category, Re-Exam Status, Shift).
          </li>
          <li>
            For first-time submission, choose <span class="no">❌ No</span> and fill correct details.
          </li>
        </ul>
      </div>

      <div class="row" style="margin-top:20px">
        <button class="btn" onclick="onPopupAnswer(true)"><i class="fas fa-check"></i> Yes</button>
        <button class="btn secondary" onclick="onPopupAnswer(false)"><i class="fas fa-times"></i> No</button>
      </div>
    </div>
  </div>

  <!-- FORM -->
  <div class="card" id="formWrap">
    <h2>📋 CBAT Details Form</h2>
    <p><em>All fields are mandatory. (You will get CSV on our Telegram channel.)</em></p>

    <div class="info-box">
      <h3>⚠️ Important Instructions</h3>
      <ul>
        <li>
          <span class="good">✔️ Fill only once</span>.  
          To <u>update details</u>, use the <b>same Unique CBAT RollNo</b> you filled the first time.  
          Enter correct information again (Date, Part A Marks, Battery-wise Attempts, Zone, Category, Re-Exam Status, Shift).
        </li>
        <li>
          <span class="bad">❌ Do not fill fake or incorrect details</span> (e.g. wrong Zone/Shift, Part A Marks, or putting all Battery Correct Attempts as <b>0</b> just to check averages).  
          <br>👉 Such actions will affect everyone’s <b>Average & T-Score</b>.
        </li>
      </ul>
    </div>
    <form id="cbatForm" class="grid"></form>

    <div class="row" style="margin-top:20px">
      <button class="btn" id="submitBtn" type="button"><i class="fas fa-paper-plane"></i> Submit</button>
      <button class="btn secondary" type="button" onclick="resetForm()"><i class="fas fa-redo"></i> Reset</button>
    </div>
  </div>

  <!-- REPORT -->
  <div class="card" id="reportWrap">
    <div id="reportMeta"></div>
    <table id="reportTable"></table>
    <div class="row" style="margin-top:20px">
      <button class="btn" onclick="scrollToTop()"><i class="fas fa-arrow-up"></i> Back to Top</button>
    </div>
  </div>

  <!-- ADMIN -->
  <div class="card" id="adminWrap">
    <h2>Admin Panel</h2>
    <div class="row">
      <input id="adminPass" type="password" placeholder="Enter admin password" style="min-width:280px" />
      <button class="btn warn" onclick="downloadCSV()"><i class="fas fa-download"></i> Generate & Download CSV</button>
    </div>
    <p id="adminHint" style="margin-top:12px; display:none;"><i class="fas fa-spinner fa-spin"></i> Generating…</p>
  </div>
</div>

<footer>
  © 2025 CBAT Analytics. Built with ❤️ for Help of ALP CBAT candidates | Disclaimer: This is not an official website of Indian Railways.
</footer>

<script>
/* ===== CONFIG ===== */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwS_z-uoiyp3Y95nqZ8E0wQoNr4fZiiVd5Jv_o44Impu2di-7nk22JOzL0I3qqnmgg8/exec"; // <-- set me

/* ===== UTIL ===== */
const qs = sel => document.querySelector(sel);
const qsa = sel => [...document.querySelectorAll(sel)];
function toast(msg, type='info'){
  alert(msg); // simple & universal
}
function scrollToTop(){ window.scrollTo({top:0, behavior:'smooth'}); }

// ====== Date formatting ======
function formatDateISOtoDisplay(dateStr){
  if (!dateStr) return '';
  const d = new Date(dateStr);
  if (isNaN(d)) return dateStr; // fallback
  const day = String(d.getDate()).padStart(2,'0');
  const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  const mon = monthNames[d.getMonth()];
  const year = d.getFullYear();
  return `${day}-${mon}-${year}`;
}

/* ===== POPUP FLOW ===== */
function onPopupAnswer(yes){
  qs('#firstPopup').style.display = 'none';
  if (yes){
    const roll = prompt('Enter your 15 digit ALP 2024 CBAT Unique Roll No, Which you filled while Submitting the Form :\nअपना 15 अंकों का ALP 2024 CBAT यूनिक रोल नंबर दर्ज करें, जो आपने फॉर्म जमा करते समय भरा था:');
    if (!roll) { qs('#formWrap').style.display = 'block'; return; }
    if (!/^\d{15}$/.test(roll)){ toast('Roll No must be exactly 15 digits.'); qs('#formWrap').style.display='block'; return; }
    fetchReport(roll).then(r=>{
      if (r.status==='ok'){
        renderReport(r);
      } else if (r.status==='not_found'){
        if (confirm('Roll not found. Try again? Click "Cancel" to fill the form.')) {
          onPopupAnswer(true);
        } else {
          qs('#formWrap').style.display = 'block';
        }
      } else {
        toast('Error fetching report. Please fill the form.');
        qs('#formWrap').style.display = 'block';
      }
    }).catch(()=>{ toast('Network error. Please fill the form.'); qs('#formWrap').style.display='block'; });
  } else {
    qs('#formWrap').style.display = 'block';
  }
}

/* ===== API CALLS (CORS-friendly) ===== */
async function apiGet(params){
  const url = SCRIPT_URL + '?' + new URLSearchParams(params).toString();
  const res = await fetch(url, { method:'GET', mode:'cors' });
  const ct = res.headers.get('content-type')||'';
  if (ct.includes('application/json')) return res.json();
  return res.text();
}
async function apiPostJson(obj){
  // Use text/plain to avoid preflight
  const res = await fetch(SCRIPT_URL, {
    method:'POST',
    mode:'cors',
    headers:{ 'Content-Type':'text/plain' },
    body: JSON.stringify(obj)
  });
  const ct = res.headers.get('content-type')||'';
  if (ct.includes('application/json')) return res.json();
  return res.text();
}

async function fetchReport(roll){
  return apiGet({ action:'getReport', roll });
}
async function checkRollExists(roll){
  const r = await apiPostJson({ type:'checkRoll', roll });
  return !!(r && r.exists);
}
async function saveOrUpdate(payload, forceUpdate=false){
  return apiPostJson({ type:'saveOrUpdate', payload, forceUpdate });
}

/* ===== FORM BUILD & VALIDATION ===== */
function buildForm(){
  const f = qs('#cbatForm');
  f.innerHTML = '';

  // Helper builders
  const addField = (label, id, type='text', attrs={})=>{
    const wrap = document.createElement('div');
    wrap.className = 'field col-6';
    wrap.innerHTML = `<label for="${id}">${label}</label>`;
    const inp = document.createElement('input');
    inp.id = id; inp.type = type;
    Object.entries(attrs).forEach(([k,v])=> inp.setAttribute(k,v));
    wrap.appendChild(inp);
    f.appendChild(wrap);
  };
  const addSelect = (label, id, options, attrs={})=>{
    const wrap = document.createElement('div');
    wrap.className = 'field col-6';
    wrap.innerHTML = `<label for="${id}">${label}</label>`;
    const sel = document.createElement('select'); sel.id = id;
    Object.entries(attrs).forEach(([k,v])=> sel.setAttribute(k,v));
    const def = document.createElement('option'); def.value=''; def.textContent='-- Select --'; sel.appendChild(def);
    options.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); });
    wrap.appendChild(sel);
    f.appendChild(wrap);
  };
  const addNumber = (label, id, min, max, step=1)=>{
    addField(label, id, 'number', { min, max, step, required:'required' });
  };

  // 1) Re-Exam?
  addSelect('Have you been called for a re-exam of RRB ALP 2024 CBAT Exam on 31 August?<br>क्या आपको 31 अगस्त को आरआरबी एएलपी 2024 सीबीएटी परीक्षा की पुनः परीक्षा के लिए बुलाया गया है?', 'ReExam', ['Yes','No'], { required:'required' });
  document.querySelector('#ReExam').parentElement.className = 'field col-12';

  // 2) Roll No (15-digit)
  addField('Enter exact 15-digit Unique Roll no (ALP 2024 CBAT held on 15-July-2025) <strong><u>[Note it down or Save it, So you can Later Check Updated Average & T-score]</u></strong><br>सटीक 15-अंकीय यूनीक रोल नंबर दर्ज करें (ALP 2024 CBAT 15-जुलाई-2025 को आयोजित) <strong><u>[इसे नोट कर लें या सेव कर लें, ताकि आप बाद में अपडेट किए गए औसत और टी-स्कोर की जांच कर सकें]</u></strong> :-', 'RollNo', 'text', { required:'required', pattern:'\\d{15}', maxlength:'15' });
  document.querySelector('#RollNo').parentElement.className = 'field col-12';

  // 3) Category
  addSelect('Category<br>कैटेगरी', 'Category', ['UR','EWS','OBC','SC','ST'], { required:'required' });


  // 4) CBT-2 Part A Marks (0..100)
  addNumber('CBT-2 Part A Marks (As per Score Card Exact Marks) (25-100)<br>सीबीटी-2 भाग ए के अंक (स्कोर कार्ड के अनुसार सटीक अंक) :-', 'PartAMarks', 25, 100);

  // 5) Zone
  addSelect('RRB Zone (as per application form)<br>आरआरबी जोन (आवेदन पत्र के अनुसार) :-', 'Zone', [
    'Ahmedabad','Ajmer','Bangalore','Bhopal','Bhubaneswar','Bilaspur','Chandigarh',
    'Chennai','Gorakhpur','Guwahati','Jammu and Srinagar','Kolkata','Malda','Mumbai',
    'Muzaffarpur','Patna','Prayagraj','Ranchi','Secunderabad','Siliguri','Thiruvananthapuram'
  ], { required:'required' });

  // 6) Exam Date (default 15-July-2024 but user can edit)
  addField('CBAT Exam Date (default 15-July-2024)<br>सीबीएटी परीक्षा तिथि (डिफ़ॉल्ट 15-जुलाई-2024)', 'ExamDate', 'date', { required:'required', value:'2025-07-15' });

  // 7) Shift (1st/2nd/3rd)
  addSelect('Shift<br>शिफ्ट', 'Shift', ['1st','2nd','3rd'], { required:'required' });

  // Batteries: Attempts
  // 8) Memory (0..24)
  addNumber('Battery 1 🧠 Memory (Figure-Find) <strong><u>Correct Attempts (0-24)</u></strong><br>बैटरी 1 🧠 मेमोरी (आकृति-खोज) <strong><u>सही प्रयास (0-24)</u></strong>', 'Mem_Correct', 0, 24);

  // 9) Directions (0..20)
  addNumber('Battery 2 🕒 Directions (Watch) <strong><u>Correct Attempts (0-20)</u></strong><br>बैटरी 2 🕒 दिशा-निर्देश (देखें) <strong><u>सही प्रयास (0-20)</u></strong>', 'Dir_Correct', 0, 20);

  // 10) Depth Perception (0..50)
  addNumber('Battery 3 🧊 Depth Perception (Hidden Cube) <strong><u>Correct Attempts (0-50)</u></strong><br>बैटरी 3 🧊 गहराई बोध (हिडन क्यूब) <strong><u>सही प्रयास (0-50)</u></strong>', 'Depth_Correct', 0, 50);

  // 11) Concentration (0..60)
  addNumber('Battery 4 🎯 Concentration (Figure Placement) <strong><u>Correct Attempts (0-60)</u></strong><br>बैटरी 4 🎯 एकाग्रता (आकृति प्लेसमेंट) <strong><u>सही प्रयास (0-60)</u></strong>', 'Conc_Correct', 0, 60);

  // 12) Perceptual Speed (0..72)
  addNumber('Battery 5 ⚡ Perceptual Speed (Same Figure) <strong><u>Correct Attempts (0-72)</u></strong><br>बैटरी 5 ⚡ अवधारणात्मक गति (समान आकृति मिलान) <strong><u>सही प्रयास (0-72)</u></strong>', 'Perc_Correct', 0, 72);

  // submit
  qs('#submitBtn').onclick = onSubmitForm;
}

function getFormData(){
  const val = id => (qs('#'+id).value||'').trim();
  const num = id => Number(val(id));
  const payload = {
    ReExam: val('ReExam'),
    RollNo: val('RollNo'),
    Category: val('Category'),

    PartAMarks: num('PartAMarks'),
    Zone: val('Zone'),
    ExamDate: val('ExamDate'),
    Shift: val('Shift'),

    Mem_Correct: num('Mem_Correct'),
    Dir_Correct: num('Dir_Correct'),
    Depth_Correct: num('Depth_Correct'),
    Conc_Correct: num('Conc_Correct'),
    Perc_Correct: num('Perc_Correct'),
  };
  return payload;
}

function validatePayload(p){
  if (!['Yes','No'].includes(p.ReExam)) return 'Select Re-Exam Yes/No';
  if (!/^\d{15}$/.test(p.RollNo)) return 'Roll No must be exactly 15 digits';
  const inRange = (x,min,max)=> Number.isFinite(x) && x>=min && x<=max;
  
  if (!['UR','EWS','OBC','SC','ST'].includes(p.Category)) return 'Select Category';

  if (!inRange(p.PartAMarks,25,100)) return 'CBT-2 Part A must be 25..100';
  if (!p.Zone) return 'Select Zone';
  if (!p.ExamDate) return 'Enter Exam Date';
  if (!['1st','2nd','3rd'].includes(p.Shift)) return 'Select Shift';

  if (!inRange(p.Mem_Correct,0,24)) return 'Battery 1 Attempts 0..24';

  if (!inRange(p.Dir_Correct,0,20)) return 'Battery 2 Attempts 0..20';

  if (!inRange(p.Depth_Correct,0,50)) return 'Battery 3 Attempts 0..50';

  if (!inRange(p.Conc_Correct,0,60)) return 'Battery 4 Attempts 0..60';

  if (!inRange(p.Perc_Correct,0,72)) return 'Battery 5 Attempts 0..72';

  return null;
}

async function onSubmitForm(){
  const payload = getFormData();
  const err = validatePayload(payload);
  if (err){ toast(err, 'error'); return; }

  try{
    const exists = await checkRollExists(payload.RollNo);
    if (exists){
      const ok = confirm('Important Note: Do not use someone else\'s Unique RollNo. This will affect both your Filled Forms. Always use your own unique ALP CBAT RollNo.\nमहत्वपूर्ण नोट: किसी और का यूनिक रोल नंबर इस्तेमाल न करें। इससे आपके दोनों भरे हुए फॉर्म प्रभावित होंगे। हमेशा अपना खुद का ALP CBAT यूनिक रोल नंबर ही इस्तेमाल करें।\nThis roll number already exists.\nA) Click OK to overwrite and update report.\nB) Click Cancel to keep old data and just view existing report.');
      if (ok){
        const resp = await saveOrUpdate(payload, true);
        if (resp && resp.status==='ok' && resp.report){
          renderReport(resp.report);
          toast('Updated successfully ✔️');
        } else {
          toast('Update failed. Please try again.', 'error');
        }
      } else {
        // B) show existing report without saving
        const rep = await fetchReport(payload.RollNo);
        if (rep && rep.status==='ok') renderReport(rep);
        else toast('Could not load existing report. Try again later.', 'error');
      }
    } else {
      // new insert
      const resp = await saveOrUpdate(payload, false);
      if (resp && resp.status==='ok' && resp.report){
        renderReport(resp.report);
        toast('Submitted successfully ✔️');
      } else if (resp && resp.status==='exists'){
        // extremely rare race
        toast('Data exists now; please choose update.', 'warn');
      } else {
        toast('Submit failed. Try again.', 'error');
      }
    }
  } catch(e){
    console.error(e);
    toast('Network error. Try again.', 'error');
  }
}

/* ===== REPORT RENDER ===== */
function renderReport(data){
  // show report section
  qs('#reportWrap').style.display = 'block';
  qs('#formWrap').style.display = 'none';

  const m = data.meta;
  const metaHtml = `
    <h2> 📊 Report for Roll: ${m.roll}</h2>
    <div class="note-box">
      <p>📝 <strong>Note:</strong> Save this <strong>RollNo</strong>.  
      Later you can use it to see your <strong>Updated Average</strong> and <strong>T-Score</strong>.</p>

      <p>📝 <strong>नोट:</strong> इस <strong>रोल नंबर</strong> को नोट कर लें या सेव कर लें।  
      ताकि बाद में आप अपना <strong>अपडेटेड औसत</strong> और <strong>टी-स्कोर</strong> देख सकें।</p>
    </div>
    <div class="row" style="flex-wrap:wrap">
      <span class="pill">Zone: <strong>${m.zone}</strong></span>
      <span class="pill">Category: <strong>${m.category}</strong></span>
      <span class="pill">Date: <strong>${formatDateISOtoDisplay(m.examDate)}</strong></span>
      <span class="pill">Shift: <strong>${m.shift}</strong></span>
      <span class="pill">Group: <strong>${m.reportType}</strong></span>
      <span class="pill">Group Size: <strong>${m.groupSize}</strong></span>
    </div>
    <p style="margin-top:8px">T‑Score formula: <code>T = 50 + 10 * (X − Mean) / SD</code>.<br> Standard Deviation SD = σ = √(∑(xi - μ)² / N).<br> Overall (X/30) = <code>(Σ T_i * 30) / 400</code>.</p>
  `;
  qs('#reportMeta').innerHTML = metaHtml;

  const rows = [
    ['Battery', 'Mean', 'SD', 'Your Raw X', 'T‑Score'],
    [' 🧠 ' + data.batteries.B1.name, fmt(data.batteries.B1.mean), fmt(data.batteries.B1.sd), data.batteries.B1.correct, data.batteries.B1.t],
    [' 🕒 ' + data.batteries.B2.name, fmt(data.batteries.B2.mean), fmt(data.batteries.B2.sd), data.batteries.B2.correct, data.batteries.B2.t],
    [' 🧊 ' + data.batteries.B3.name, fmt(data.batteries.B3.mean), fmt(data.batteries.B3.sd), data.batteries.B3.correct, data.batteries.B3.t],
    [' 🎯 ' + data.batteries.B4.name, fmt(data.batteries.B4.mean), fmt(data.batteries.B4.sd), data.batteries.B4.correct, data.batteries.B4.t],
    [' ⚡ ' + data.batteries.B5.name, fmt(data.batteries.B5.mean), fmt(data.batteries.B5.sd), data.batteries.B5.correct, data.batteries.B5.t]
  ];
  let html = `<thead><tr>${rows[0].map(c=>`<th>${c}</th>`).join('')}</tr></thead><tbody>`;
  for (let i=1;i<rows.length;i++){
    const r = rows[i];
    html += `<tr>${r.map((c,j)=>`<td>${j===0?'<strong>'+c+'</strong>':c}</td>`).join('')}</tr>`;
  }
  html += `</tbody><tfoot><tr><th colspan="4" style="text-align:right; color: white;"><strong> 📈 Overall Score (out of 30)</strong></th><th style="color: white;"><strong>${data.overall}</strong></th></tr></tfoot>`;
  qs('#reportTable').innerHTML = html;
}
function fmt(x){ return (typeof x==='number') ? x.toFixed(2) : x; }

function resetForm(){
  qsa('#cbatForm input, #cbatForm select').forEach(el=>{
    if (el.id==='ExamDate') el.value = '2025-07-15';
    else if (el.tagName==='SELECT') el.selectedIndex = 0;
    else el.value = '';
  });
}

/* ===== ADMIN ===== */
async function downloadCSV(){
  const pass = qs('#adminPass').value || '';
  if (!pass){ toast('Enter password ❗'); return; }
  qs('#adminHint').style.display='block';
  try{
    const url = SCRIPT_URL + '?' + new URLSearchParams({ action:'adminExport', password: pass });
    const res = await fetch(url, { method:'GET', mode:'cors' });
    if (!res.ok){
      qs('#adminHint').style.display='none';
      toast('Unauthorized or error.', 'error'); return;
    }
    const ct = res.headers.get('content-type') || '';
    if (!ct.includes('text/csv')){
      const text = await res.text();
      qs('#adminHint').style.display='none';
      try{
        const j = JSON.parse(text);
        if (j.status==='unauthorized'){ toast('Wrong password ❌', 'error'); return; }
      }catch{}
      toast('Unexpected response.', 'error'); return;
    }
    const blob = await res.blob();
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `CBAT_Export_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    qs('#adminHint').style.display='none';
  } catch(e){
    console.error(e);
    qs('#adminHint').style.display='none';
    toast('Network error while downloading CSV', 'error');
  }
}

/* ===== INIT ===== */

function showAdmin() {
  qs('#adminWrap').style.display = 'block';
  qs('#firstPopup').style.display = 'none';
  qs('#formWrap').style.display = 'none';
  qs('#reportWrap').style.display = 'none';
}

function showUser() {
  qs('#adminWrap').style.display = 'none';
  qs('#firstPopup').style.display = 'flex';
  qs('#formWrap').style.display = 'none';
  qs('#reportWrap').style.display = 'none';
  buildForm();
}

function handleRoute() {
  const hash = location.hash.toLowerCase();
  if (hash === '#admin') {
    showAdmin();
  } else {
    showUser();
  }
}

document.addEventListener('DOMContentLoaded', handleRoute);
window.addEventListener('hashchange', handleRoute); // ✅ switch instantly on # change

</script>
</body>
</html>
