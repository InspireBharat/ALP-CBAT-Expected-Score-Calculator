<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RRB ALP 2024 CBAT ‚Äì T‚ÄëScore & Report</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root {
    --bg: #0a0f1f;
    --card: #121834;
    --accent: #4f8cff;
    --accent2: #00d4a6;
    --text: #e8ecff;
    --muted: #a9b3d6;
    --warn: #ffb020;
    --danger: #ff5565;
    --card-gradient: linear-gradient(145deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
    --input-bg: rgba(13, 19, 42, 0.7);
    --success: #00c781;
  }
  
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  
  body {
    font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
    color: var(--text);
    background: radial-gradient(1200px 600px at 10% -10%, #1b2658 0, #0a0f1f 60%);
    min-height: 100vh;
    line-height: 1.6;
  }
  
  /* NAV */
  nav {
    position: sticky;
    top: 0;
    z-index: 10;
    background: rgba(10, 15, 31, 0.85);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }
  
  .nav-inner {
    max-width: 1100px;
    margin: 0 auto;
    padding: 12px 16px;
    display: flex;
    align-items: center;
    gap: 16px;
  }
  
  .brand {
    display: flex;
    align-items: center;
    gap: 10px;
    text-decoration: none;
    color: var(--text);
    font-weight: 700;
    font-size: 1.1rem;
  }
  
  .spacer {
    flex: 1;
  }
  
  .nav-link {
    color: var(--muted);
    text-decoration: none;
    margin-left: 14px;
    transition: color 0.2s ease;
  }
  
  .nav-link:hover {
    color: var(--text);
  }
  
  .home-btn {
    color: var(--text);
    text-decoration: none;
    font-weight: 600;
  }
  
  .btn-telegram {
    background: linear-gradient(90deg, #0088cc, #2AABEE);
    color: white !important;
    border: none;
    padding: 10px 16px;
    border-radius: 10px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
    text-decoration: none;
    transition: all 0.2s ease;
    box-shadow: 0 4px 12px rgba(42, 171, 238, 0.3);
  }
  
  .btn-telegram:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(42, 171, 238, 0.4);
  }

  /* Style for date input with glowing white calendar icon */
input[type="date"] {
  position: relative;
  padding-right: 40px; /* space for the icon */
  background: #222;
  color: #fff;
  border: 1px solid #555;
  border-radius: 5px;
  font-size: 16px;
  height: 40px;
  box-shadow: inset 0 0 5px rgba(255,255,255,0.2);
}

/* Remove default browser calendar icon */
input[type="date"]::-webkit-calendar-picker-indicator {
  opacity: 0;
  cursor: pointer;
  position: absolute;
  right: 10px;
  height: 100%;
  width: 30px;
}

/* Add custom white glowing calendar icon */
input[type="date"]::after {
  content: "üìÖ";
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  color: white;
  font-size: 18px;
  pointer-events: none;
  text-shadow: 0 0 8px rgba(255,255,255,0.8);
}

  /* Layout */
  .container {
    max-width: 1100px;
    margin: 32px auto;
    padding: 0 16px;
  }
  
  .card {
    background: var(--card-gradient);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 18px;
    padding: 28px;
    box-shadow: 0 12px 30px rgba(0, 0, 0, 0.3);
    margin-bottom: 24px;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  
  .card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
  }
  
  h1 {
    font-size: 32px;
    margin: 0 0 12px;
    background: linear-gradient(90deg, var(--text), var(--accent));
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    font-weight: 800;
  }
  
  h2 {
    font-size: 24px;
    margin: 0 0 12px;
    color: #dfe6ff;
    font-weight: 700;
    padding-bottom: 8px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }
  
  h3 {
    font-size: 20px;
    margin: 0 0 8px;
    color: #dfe6ff;
    font-weight: 600;
  }
  
  p {
    color: var(--muted);
    margin-bottom: 16px;
  }

  /* Popup */
  .popup {
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(5px);
    z-index: 999;
    animation: fadeIn 0.3s ease;
  }
  
  .popup .panel {
    width: min(520px, 92%);
    background: var(--card);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 18px;
    padding: 28px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
    animation: slideUp 0.4s ease;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  @keyframes slideUp {
    from { 
      opacity: 0;
      transform: translateY(20px);
    }
    to { 
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Form styling */
  .grid {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    gap: 16px;
    margin-top: 20px;
  }
  
  .col-12 {
    grid-column: span 12;
  }
  
  .col-6 {
    grid-column: span 6;
  }
  
  .col-4 {
    grid-column: span 4;
  }
  
  .field {
    display: flex;
    flex-direction: column;
    gap: 8px;
    position: relative;
  }
  
  label {
    font-size: 14px;
    color: #cbd5ff;
    font-weight: 500;
  }
  
  input, select {
    background: var(--input-bg);
    color: var(--text);
    border: 1px solid rgba(255, 255, 255, 0.12);
    padding: 14px 16px;
    border-radius: 12px;
    outline: none;
    font-size: 15px;
    transition: all 0.3s ease;
  }
  
  input:hover, select:hover {
    border-color: rgba(255, 255, 255, 0.2);
  }
  
  input:focus, select:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(79, 140, 255, 0.25);
    transform: translateY(-2px);
  }
  
  .row {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
    margin-top: 20px;
  }
  
  .btn {
    appearance: none;
    border: none;
    cursor: pointer;
    padding: 14px 20px;
    border-radius: 12px;
    font-weight: 600;
    font-size: 15px;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }
  
  .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(79, 140, 255, 0.4);
  }
  
  .btn:active {
    transform: translateY(0);
  }
  
  .btn {
    background: linear-gradient(90deg, var(--accent), #7aa5ff);
    color: #071028;
    box-shadow: 0 8px 20px rgba(79, 140, 255, 0.35);
  }
  
  .btn.secondary {
    background: rgba(13, 19, 42, 0.7);
    color: var(--text);
    border: 1px solid rgba(255, 255, 255, 0.16);
    box-shadow: none;
  }
  
  .btn.secondary:hover {
    background: rgba(20, 28, 58, 0.8);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
  }
  
  .btn.warn {
    background: linear-gradient(90deg, var(--warn), #ffd28a);
    color: #2a1700;
    box-shadow: 0 8px 20px rgba(255, 176, 32, 0.35);
  }
  
  .btn.danger {
    background: linear-gradient(90deg, var(--danger), #ff98a4);
    color: #2a0005;
    box-shadow: 0 8px 20px rgba(255, 85, 101, 0.35);
  }

  /* Tables */
  table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    margin-top: 20px;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
  }
  
  thead {
    background: linear-gradient(90deg, var(--accent), #6b9dff);
  }
  
  th, td {
    padding: 16px 20px;
    text-align: left;
  }
  
  th {
    color: #071028;
    font-weight: 700;
    font-size: 15px;
  }
  
  tbody tr {
    background: rgba(255, 255, 255, 0.05);
    transition: background 0.2s ease;
  }
  
  tbody tr:nth-child(even) {
    background: rgba(255, 255, 255, 0.03);
  }
  
  tbody tr:hover {
    background: rgba(79, 140, 255, 0.15);
  }
  
  td {
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
  }
  
  tr:last-child td {
    border-bottom: none;
  }
  
  td small {
    color: var(--muted);
    font-size: 13px;
  }
  
  .pill {
    display: inline-flex;
    gap: 6px;
    align-items: center;
    padding: 6px 12px;
    border-radius: 999px;
    border: 1px solid rgba(255, 255, 255, 0.12);
    background: rgba(255, 255, 255, 0.08);
    color: #e7eeff;
    font-size: 13px;
    font-weight: 500;
  }

  /* Sections */
  #formWrap, #reportWrap, #adminWrap {
    display: none;
  }
  
  #reportMeta {
    background: rgba(255, 255, 255, 0.05);
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 20px;
    border-left: 4px solid var(--accent);
  }
  
  .score-highlight {
    font-size: 24px;
    font-weight: 700;
    color: var(--accent2);
    margin: 10px 0;
  }

  /* Footer */
  footer {
    text-align: center;
    color: var(--muted);
    margin: 40px 0;
    font-size: 14px;
    padding: 20px;
    border-top: 1px solid rgba(255, 255, 255, 0.08);
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .grid {
      grid-template-columns: 1fr;
      gap: 12px;
    }
    
    .col-6, .col-4 {
      grid-column: span 1;
    }
    
    .row {
      flex-direction: column;
      gap: 12px;
    }
    
    .nav-inner {
      flex-wrap: wrap;
    }
    
    h1 {
      font-size: 26px;
    }
    
    h2 {
      font-size: 22px;
    }
    
    .card {
      padding: 20px;
    }
    .field.col-6 { 
        width: 48%; 
        display:inline-block; 
        margin-right:2%; 
    }
    .field.col-12 { 
        width: 100%; 
        display:block; 
    }
  }
</style>
</head>
<body>

<nav>
  <div class="nav-inner">
    <a class="brand home-btn" href="./">
        <span class="glow-text">RRB ALP 2024 CBAT Expected Score Calculator</span>
    </a>
    <a class="btn btn-outline-light btn-glow" href="./"> 
        <i class="fas fa-home"></i> Home
    </a>
    <div class="spacer"></div>
    <a class="btn btn-telegram btn-glow me-2" href="https://t.me/Akki_Inspire" target="_blank" title="Join Telegram">
      <strong><i class="fab fa-telegram"></i> Join our Telegram</strong>
    </a>
  </div>
</nav>

<div class="container">
  <div class="card" id="hero">
    <h1>CBAT T‚ÄëScore & Overall Score (out of 30)</h1>
    <p>Auto-calculated from your Battery raw scores within <strong>same Zone + Exam Date + Shift</strong> and grouped by <strong>Re‚ÄëExam</strong> status.</p>
  </div>

  <!-- POPUP -->
  <div class="popup" id="firstPopup">
    <div class="panel">
      <h2>Have you filled the form earlier?</h2>
      <div class="row" style="margin-top:20px">
        <button class="btn" onclick="onPopupAnswer(true)"><i class="fas fa-check"></i> Yes</button>
        <button class="btn secondary" onclick="onPopupAnswer(false)"><i class="fas fa-times"></i> No</button>
      </div>
    </div>
  </div>

  <!-- FORM -->
  <div class="card" id="formWrap">
    <h2>CBAT Details Form</h2>
    <p><em>All fields are mandatory. (You will get CSV on our Telegram channel.)</em></p>

    <form id="cbatForm" class="grid"></form>

    <div class="row" style="margin-top:20px">
      <button class="btn" id="submitBtn" type="button"><i class="fas fa-paper-plane"></i> Submit</button>
      <button class="btn secondary" type="button" onclick="resetForm()"><i class="fas fa-redo"></i> Reset</button>
    </div>
  </div>

  <!-- REPORT -->
  <div class="card" id="reportWrap">
    <div id="reportMeta"></div>
    <table id="reportTable"></table>
    <div class="row" style="margin-top:20px">
      <button class="btn" onclick="scrollToTop()"><i class="fas fa-arrow-up"></i> Back to Top</button>
    </div>
  </div>

  <!-- ADMIN -->
  <div class="card" id="adminWrap">
    <h2>Admin Panel</h2>
    <div class="row">
      <input id="adminPass" type="password" placeholder="Enter admin password" style="min-width:280px" />
      <button class="btn warn" onclick="downloadCSV()"><i class="fas fa-download"></i> Generate & Download CSV</button>
    </div>
    <p id="adminHint" style="margin-top:12px; display:none;"><i class="fas fa-spinner fa-spin"></i> Generating‚Ä¶</p>
  </div>
</div>

<footer>
  ¬© 2025 CBAT Analytics. Built with ‚ù§Ô∏è for Help of ALP CBAT candidates | Disclaimer: This is not an official website of Indian Railways.
</footer>

<script>
/* ===== CONFIG ===== */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwS_z-uoiyp3Y95nqZ8E0wQoNr4fZiiVd5Jv_o44Impu2di-7nk22JOzL0I3qqnmgg8/exec"; // <-- set me

/* ===== UTIL ===== */
const qs = sel => document.querySelector(sel);
const qsa = sel => [...document.querySelectorAll(sel)];
function toast(msg, type='info'){
  alert(msg); // simple & universal
}
function scrollToTop(){ window.scrollTo({top:0, behavior:'smooth'}); }

/*
const pathIsAdmin =  location.pathname.endsWith('#admin') // || location.pathname.endsWith('/admin');
document.addEventListener('DOMContentLoaded', () => {
  if (pathIsAdmin) {
    qs('#adminWrap').style.display = 'block';
    qs('#firstPopup').style.display = 'none';
    qs('#formWrap').style.display = 'none';
    qs('#reportWrap').style.display = 'none';
  } else {
    qs('#firstPopup').style.display = 'flex';
    buildForm();
  }
});
*/

// ====== Date formatting ======
function formatDateISOtoDisplay(dateStr){
  if (!dateStr) return '';
  const d = new Date(dateStr);
  if (isNaN(d)) return dateStr; // fallback
  const day = String(d.getDate()).padStart(2,'0');
  const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  const mon = monthNames[d.getMonth()];
  const year = d.getFullYear();
  return `${day}-${mon}-${year}`;
}

/* ===== POPUP FLOW ===== */
function onPopupAnswer(yes){
  qs('#firstPopup').style.display = 'none';
  if (yes){
    const roll = prompt('Enter your 15 digit ALP 2024 CBAT Roll No:');
    if (!roll) { qs('#formWrap').style.display = 'block'; return; }
    if (!/^\d{15}$/.test(roll)){ toast('Roll No must be exactly 15 digits.'); qs('#formWrap').style.display='block'; return; }
    fetchReport(roll).then(r=>{
      if (r.status==='ok'){
        renderReport(r);
      } else if (r.status==='not_found'){
        if (confirm('Roll not found. Try again? Click "Cancel" to fill the form.')) {
          onPopupAnswer(true);
        } else {
          qs('#formWrap').style.display = 'block';
        }
      } else {
        toast('Error fetching report. Please fill the form.');
        qs('#formWrap').style.display = 'block';
      }
    }).catch(()=>{ toast('Network error. Please fill the form.'); qs('#formWrap').style.display='block'; });
  } else {
    qs('#formWrap').style.display = 'block';
  }
}

/* ===== API CALLS (CORS-friendly) ===== */
async function apiGet(params){
  const url = SCRIPT_URL + '?' + new URLSearchParams(params).toString();
  const res = await fetch(url, { method:'GET', mode:'cors' });
  const ct = res.headers.get('content-type')||'';
  if (ct.includes('application/json')) return res.json();
  return res.text();
}
async function apiPostJson(obj){
  // Use text/plain to avoid preflight
  const res = await fetch(SCRIPT_URL, {
    method:'POST',
    mode:'cors',
    headers:{ 'Content-Type':'text/plain' },
    body: JSON.stringify(obj)
  });
  const ct = res.headers.get('content-type')||'';
  if (ct.includes('application/json')) return res.json();
  return res.text();
}

async function fetchReport(roll){
  return apiGet({ action:'getReport', roll });
}
async function checkRollExists(roll){
  const r = await apiPostJson({ type:'checkRoll', roll });
  return !!(r && r.exists);
}
async function saveOrUpdate(payload, forceUpdate=false){
  return apiPostJson({ type:'saveOrUpdate', payload, forceUpdate });
}

/* ===== FORM BUILD & VALIDATION ===== */
function buildForm(){
  const f = qs('#cbatForm');
  f.innerHTML = '';

  // Helper builders
  const addField = (label, id, type='text', attrs={})=>{
    const wrap = document.createElement('div');
    wrap.className = 'field col-6';
    wrap.innerHTML = `<label for="${id}">${label}</label>`;
    const inp = document.createElement('input');
    inp.id = id; inp.type = type;
    Object.entries(attrs).forEach(([k,v])=> inp.setAttribute(k,v));
    wrap.appendChild(inp);
    f.appendChild(wrap);
  };
  const addSelect = (label, id, options, attrs={})=>{
    const wrap = document.createElement('div');
    wrap.className = 'field col-6';
    wrap.innerHTML = `<label for="${id}">${label}</label>`;
    const sel = document.createElement('select'); sel.id = id;
    Object.entries(attrs).forEach(([k,v])=> sel.setAttribute(k,v));
    const def = document.createElement('option'); def.value=''; def.textContent='-- Select --'; sel.appendChild(def);
    options.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); });
    wrap.appendChild(sel);
    f.appendChild(wrap);
  };
  const addNumber = (label, id, min, max, step=1)=>{
    addField(label, id, 'number', { min, max, step, required:'required' });
  };

  // 1) Re-Exam?
  addSelect('Have you been called for a re-exam of RRB ALP 2024 CBAT Exam on 31 August?<br>‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™‡§ï‡•ã 31 ‡§Ö‡§ó‡§∏‡•ç‡§§ ‡§ï‡•ã ‡§Ü‡§∞‡§Ü‡§∞‡§¨‡•Ä ‡§è‡§è‡§≤‡§™‡•Ä 2024 ‡§∏‡•Ä‡§¨‡•Ä‡§è‡§ü‡•Ä ‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡•Ä ‡§™‡•Å‡§®‡§É ‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§¨‡•Å‡§≤‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à?', 'ReExam', ['Yes','No'], { required:'required' });
  document.querySelector('#ReExam').parentElement.className = 'field col-12';

  // 2) Roll No (15-digit)
  addField('Enter exact 15-digit roll no (ALP 2024 CBAT held on 15-July-2025) [So you can later check updated Avg & T-score]<br>‡§∏‡§ü‡•Ä‡§ï 15-‡§Ö‡§Ç‡§ï‡•Ä‡§Ø ‡§∞‡•ã‡§≤ ‡§®‡§Ç‡§¨‡§∞ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç (ALP 2024 CBAT 15-‡§ú‡•Å‡§≤‡§æ‡§à-2025 ‡§ï‡•ã ‡§Ü‡§Ø‡•ã‡§ú‡§ø‡§§) [‡§§‡§æ‡§ï‡§ø ‡§Ü‡§™ ‡§¨‡§æ‡§¶ ‡§Æ‡•á‡§Ç ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§ø‡§è ‡§ó‡§è ‡§î‡§∏‡§§ ‡§î‡§∞ ‡§ü‡•Ä-‡§∏‡•ç‡§ï‡•ã‡§∞ ‡§ï‡•Ä ‡§ú‡§æ‡§Ç‡§ö ‡§ï‡§∞ ‡§∏‡§ï‡•á‡§Ç] :-', 'RollNo', 'text', { required:'required', pattern:'\\d{15}', maxlength:'15' });
  document.querySelector('#RollNo').parentElement.className = 'field col-12';

  // 3) Category
  addSelect('Category<br>‡§ï‡•à‡§ü‡•á‡§ó‡§∞‡•Ä', 'Category', ['UR','EWS','OBC','SC','ST'], { required:'required' });


  // 4) CBT-2 Part A Marks (0..100)
  addNumber('CBT-2 Part A Marks (As per Score Card Exact Marks) (0-100)<br>‡§∏‡•Ä‡§¨‡•Ä‡§ü‡•Ä-2 ‡§≠‡§æ‡§ó ‡§è ‡§ï‡•á ‡§Ö‡§Ç‡§ï (‡§∏‡•ç‡§ï‡•ã‡§∞ ‡§ï‡§æ‡§∞‡•ç‡§° ‡§ï‡•á ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞ ‡§∏‡§ü‡•Ä‡§ï ‡§Ö‡§Ç‡§ï) :-', 'PartAMarks', 0, 100);

  // 5) Zone
  addSelect('RRB Zone (as per application form)<br>‡§Ü‡§∞‡§Ü‡§∞‡§¨‡•Ä ‡§ú‡•ã‡§® (‡§Ü‡§µ‡•á‡§¶‡§® ‡§™‡§§‡•ç‡§∞ ‡§ï‡•á ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞) :-', 'Zone', [
    'Ahmedabad','Ajmer','Bangalore','Bhopal','Bhubaneswar','Bilaspur','Chandigarh',
    'Chennai','Gorakhpur','Guwahati','Jammu and Srinagar','Kolkata','Malda','Mumbai',
    'Muzaffarpur','Patna','Prayagraj','Ranchi','Secunderabad','Siliguri','Thiruvananthapuram'
  ], { required:'required' });

  // 6) Exam Date (default 15-July-2024 but user can edit)
  addField('CBAT Exam Date (default 15-July-2024)<br>‡§∏‡•Ä‡§¨‡•Ä‡§è‡§ü‡•Ä ‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§§‡§ø‡§•‡§ø (‡§°‡§ø‡§´‡§º‡•â‡§≤‡•ç‡§ü 15-‡§ú‡•Å‡§≤‡§æ‡§à-2024)', 'ExamDate', 'date', { required:'required', value:'2025-07-15' });

  // 7) Shift (1st/2nd/3rd)
  addSelect('Shift<br>‡§∂‡§ø‡§´‡•ç‡§ü', 'Shift', ['1st','2nd','3rd'], { required:'required' });

  // Batteries: Attempts + Accuracy
  // 8) Memory (0..24), (0..100)
  addNumber('Battery 1 üß† Memory (Figure-Find) <strong><u>Correct Attempts (0-24)</u></strong><br>‡§¨‡•à‡§ü‡§∞‡•Ä 1 üß† ‡§Æ‡•á‡§Æ‡•ã‡§∞‡•Ä (‡§Ü‡§ï‡•É‡§§‡§ø-‡§ñ‡•ã‡§ú) <strong><u>‡§∏‡§π‡•Ä ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ (0-24)</u></strong>', 'Mem_Correct', 0, 24);

  // 9) Directions (0..20), (0..100)
  addNumber('Battery 2 üïí Directions (Watch) <strong><u>Correct Attempts (0-20)</u></strong><br>‡§¨‡•à‡§ü‡§∞‡•Ä 2 üïí ‡§¶‡§ø‡§∂‡§æ-‡§®‡§ø‡§∞‡•ç‡§¶‡•á‡§∂ (‡§¶‡•á‡§ñ‡•á‡§Ç) <strong><u>‡§∏‡§π‡•Ä ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ (0-20)</u></strong>', 'Dir_Correct', 0, 20);

  // 10) Depth Perception (0..50), (0..100)
  addNumber('Battery 3 üßä Depth Perception (Hidden Cube) <strong><u>Correct Attempts (0-50)</u></strong><br>‡§¨‡•à‡§ü‡§∞‡•Ä 3 üßä ‡§ó‡§π‡§∞‡§æ‡§à ‡§¨‡•ã‡§ß (‡§π‡§ø‡§°‡§® ‡§ï‡•ç‡§Ø‡•Ç‡§¨) <strong><u>‡§∏‡§π‡•Ä ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ (0-50)</u></strong>', 'Depth_Correct', 0, 50);

  // 11) Concentration (0..60), (0..100)
  addNumber('Battery 4 üéØ Concentration (Figure Placement) <strong><u>Correct Attempts (0-60)</u></strong><br>‡§¨‡•à‡§ü‡§∞‡•Ä 4 üéØ ‡§è‡§ï‡§æ‡§ó‡•ç‡§∞‡§§‡§æ (‡§Ü‡§ï‡•É‡§§‡§ø ‡§™‡•ç‡§≤‡•á‡§∏‡§Æ‡•á‡§Ç‡§ü) <strong><u>‡§∏‡§π‡•Ä ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ (0-60)</u></strong>', 'Conc_Correct', 0, 60);

  // 12) Perceptual Speed (0..72), (0..100)
  addNumber('Battery 5 ‚ö° Perceptual Speed (Same Figure) <strong><u>Correct Attempts (0-72)</u></strong><br>‡§¨‡•à‡§ü‡§∞‡•Ä 5 ‚ö° ‡§Ö‡§µ‡§ß‡§æ‡§∞‡§£‡§æ‡§§‡•ç‡§Æ‡§ï ‡§ó‡§§‡§ø (‡§∏‡§Æ‡§æ‡§® ‡§Ü‡§ï‡•É‡§§‡§ø ‡§Æ‡§ø‡§≤‡§æ‡§®) <strong><u>‡§∏‡§π‡•Ä ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ (0-72)</u></strong>', 'Perc_Correct', 0, 72);

  // submit
  qs('#submitBtn').onclick = onSubmitForm;
}

function getFormData(){
  const val = id => (qs('#'+id).value||'').trim();
  const num = id => Number(val(id));
  const payload = {
    ReExam: val('ReExam'),
    RollNo: val('RollNo'),
    Category: val('Category'),

    PartAMarks: num('PartAMarks'),
    Zone: val('Zone'),
    ExamDate: val('ExamDate'),
    Shift: val('Shift'),

    Mem_Correct: num('Mem_Correct'),
    Dir_Correct: num('Dir_Correct'),
    Depth_Correct: num('Depth_Correct'),
    Conc_Correct: num('Conc_Correct'),
    Perc_Correct: num('Perc_Correct'),
  };
  return payload;
}

function validatePayload(p){
  if (!['Yes','No'].includes(p.ReExam)) return 'Select Re-Exam Yes/No';
  if (!/^\d{15}$/.test(p.RollNo)) return 'Roll No must be exactly 15 digits';
  const inRange = (x,min,max)=> Number.isFinite(x) && x>=min && x<=max;
  
  if (!['UR','EWS','OBC','SC','ST'].includes(p.Category)) return 'Select Category';

  if (!inRange(p.PartAMarks,0,100)) return 'CBT-2 Part A must be 0..100';
  if (!p.Zone) return 'Select Zone';
  if (!p.ExamDate) return 'Enter Exam Date';
  if (!['1st','2nd','3rd'].includes(p.Shift)) return 'Select Shift';

  if (!inRange(p.Mem_Correct,0,24)) return 'Battery 1 Attempts 0..24';

  if (!inRange(p.Dir_Correct,0,20)) return 'Battery 2 Attempts 0..20';

  if (!inRange(p.Depth_Correct,0,50)) return 'Battery 3 Attempts 0..50';

  if (!inRange(p.Conc_Correct,0,60)) return 'Battery 4 Attempts 0..60';

  if (!inRange(p.Perc_Correct,0,72)) return 'Battery 5 Attempts 0..72';

  return null;
}

async function onSubmitForm(){
  const payload = getFormData();
  const err = validatePayload(payload);
  if (err){ toast(err, 'error'); return; }

  try{
    const exists = await checkRollExists(payload.RollNo);
    if (exists){
      const ok = confirm('This roll number already exists.\nA) Click OK to overwrite and update report.\nB) Click Cancel to keep old data and just view existing report.');
      if (ok){
        const resp = await saveOrUpdate(payload, true);
        if (resp && resp.status==='ok' && resp.report){
          renderReport(resp.report);
          toast('Updated successfully ‚úîÔ∏è');
        } else {
          toast('Update failed. Please try again.', 'error');
        }
      } else {
        // B) show existing report without saving
        const rep = await fetchReport(payload.RollNo);
        if (rep && rep.status==='ok') renderReport(rep);
        else toast('Could not load existing report. Try again later.', 'error');
      }
    } else {
      // new insert
      const resp = await saveOrUpdate(payload, false);
      if (resp && resp.status==='ok' && resp.report){
        renderReport(resp.report);
        toast('Submitted successfully ‚úîÔ∏è');
      } else if (resp && resp.status==='exists'){
        // extremely rare race
        toast('Data exists now; please choose update.', 'warn');
      } else {
        toast('Submit failed. Try again.', 'error');
      }
    }
  } catch(e){
    console.error(e);
    toast('Network error. Try again.', 'error');
  }
}

/* ===== REPORT RENDER ===== */
function renderReport(data){
  // show report section
  qs('#reportWrap').style.display = 'block';
  qs('#formWrap').style.display = 'none';

  const m = data.meta;
  const metaHtml = `
    <h2> üìä Report for Roll: ${m.roll}</h2>
    <div class="row" style="flex-wrap:wrap">
      <span class="pill">Zone: <strong>${m.zone}</strong></span>
      <span class="pill">Category: <strong>${m.category}</strong></span>
      <span class="pill">Date: <strong>${formatDateISOtoDisplay(m.examDate)}</strong></span>
      <span class="pill">Shift: <strong>${m.shift}</strong></span>
      <span class="pill">Group: <strong>${m.reportType}</strong></span>
      <span class="pill">Group Size: <strong>${m.groupSize}</strong></span>
    </div>
    <p style="margin-top:8px">T‚ÄëScore formula: <code>T = 50 + 10 * (X ‚àí Mean) / SD</code>.<br> Standard Deviation SD = œÉ = ‚àö(‚àë(xi - Œº)¬≤ / N).<br> Overall (X/30) = <code>(Œ£ T_i * 30) / 400</code>.</p>
  `;
  qs('#reportMeta').innerHTML = metaHtml;

  const rows = [
    ['Battery', 'Mean', 'SD', 'Your Raw X', 'T‚ÄëScore'],
    [' üß† ' + data.batteries.B1.name, fmt(data.batteries.B1.mean), fmt(data.batteries.B1.sd), data.batteries.B1.correct, data.batteries.B1.t],
    [' üïí ' + data.batteries.B2.name, fmt(data.batteries.B2.mean), fmt(data.batteries.B2.sd), data.batteries.B2.correct, data.batteries.B2.t],
    [' üßä ' + data.batteries.B3.name, fmt(data.batteries.B3.mean), fmt(data.batteries.B3.sd), data.batteries.B3.correct, data.batteries.B3.t],
    [' üéØ ' + data.batteries.B4.name, fmt(data.batteries.B4.mean), fmt(data.batteries.B4.sd), data.batteries.B4.correct, data.batteries.B4.t],
    [' ‚ö° ' + data.batteries.B5.name, fmt(data.batteries.B5.mean), fmt(data.batteries.B5.sd), data.batteries.B5.correct, data.batteries.B5.t]
  ];
  let html = `<thead><tr>${rows[0].map(c=>`<th>${c}</th>`).join('')}</tr></thead><tbody>`;
  for (let i=1;i<rows.length;i++){
    const r = rows[i];
    html += `<tr>${r.map((c,j)=>`<td>${j===0?'<strong>'+c+'</strong>':c}</td>`).join('')}</tr>`;
  }
  html += `</tbody><tfoot><tr><th colspan="4" style="text-align:right; color: white;"><strong> üìà Overall Score (out of 30)</strong></th><th style="color: white;"><strong>${data.overall}</strong></th></tr></tfoot>`;
  qs('#reportTable').innerHTML = html;
}
function fmt(x){ return (typeof x==='number') ? x.toFixed(2) : x; }

function resetForm(){
  qsa('#cbatForm input, #cbatForm select').forEach(el=>{
    if (el.id==='ExamDate') el.value = '2025-07-15';
    else if (el.tagName==='SELECT') el.selectedIndex = 0;
    else el.value = '';
  });
}

/* ===== ADMIN ===== */
async function downloadCSV(){
  const pass = qs('#adminPass').value || '';
  if (!pass){ toast('Enter password ‚ùó'); return; }
  qs('#adminHint').style.display='block';
  try{
    const url = SCRIPT_URL + '?' + new URLSearchParams({ action:'adminExport', password: pass });
    const res = await fetch(url, { method:'GET', mode:'cors' });
    if (!res.ok){
      qs('#adminHint').style.display='none';
      toast('Unauthorized or error.', 'error'); return;
    }
    const ct = res.headers.get('content-type') || '';
    if (!ct.includes('text/csv')){
      const text = await res.text();
      qs('#adminHint').style.display='none';
      try{
        const j = JSON.parse(text);
        if (j.status==='unauthorized'){ toast('Wrong password ‚ùå', 'error'); return; }
      }catch{}
      toast('Unexpected response.', 'error'); return;
    }
    const blob = await res.blob();
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `CBAT_Export_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    qs('#adminHint').style.display='none';
  } catch(e){
    console.error(e);
    qs('#adminHint').style.display='none';
    toast('Network error while downloading CSV', 'error');
  }
}

/* ===== INIT ===== */

function showAdmin() {
  qs('#adminWrap').style.display = 'block';
  qs('#firstPopup').style.display = 'none';
  qs('#formWrap').style.display = 'none';
  qs('#reportWrap').style.display = 'none';
}

function showUser() {
  qs('#adminWrap').style.display = 'none';
  qs('#firstPopup').style.display = 'flex';
  qs('#formWrap').style.display = 'none';
  qs('#reportWrap').style.display = 'none';
  buildForm();
}

function handleRoute() {
  const hash = location.hash.toLowerCase();
  if (hash === '#admin') {
    showAdmin();
  } else {
    showUser();
  }
}

document.addEventListener('DOMContentLoaded', handleRoute);
window.addEventListener('hashchange', handleRoute); // ‚úÖ switch instantly on # change

</script>
</body>
</html>
